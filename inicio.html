<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Equipos</title>
    <link rel="stylesheet" href="inicio.css">
    <meta name="theme-color" content="#181b20">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Favicon / Iconos -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/x-icon" href="logo.ico">
    <link rel="apple-touch-icon" href="logo.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
</head>
<body>
    <div class="header">
        <h1 class="titulo-responsive">SAL√ìN DE ASAMBLEAS <span class="break-mobile">GUAYAQUIL ECUADOR</span></h1>
        <h2>GESTI√ìN DE EQUIPOS</h2>
        <div class="user-profile-container">
            <button id="profileBtn" class="profile-btn conn-unknown" onclick="toggleProfileMenu()" title="Comprobando conexi√≥n...">
                <img id="profileAvatar" class="profile-avatar" src="" alt="" style="display:none;">
                <div id="profileAvatarFallback" class="profile-avatar-fallback">üë§</div>
                <span id="notifBadge" class="notif-badge" style="display:none">0</span>
            </button>
            <div id="profileDropdown" class="profile-dropdown" style="display:none;">
                <div class="profile-dropdown-header">
                    <div class="profile-info">
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-email" id="profileEmail"></div>
                    </div>
                </div>
                <div class="profile-dropdown-divider"></div>
                <button class="profile-dropdown-item" onclick="abrirNotificaciones(); toggleProfileMenu();">
                    <span class="profile-item-icon">üîî</span>
                    <span>Notificaciones</span>
                </button>
                <div class="profile-dropdown-divider"></div>
                <!-- Atajos Admin -->
                <div id="adminShortcuts" class="profile-admin-group" style="display:none;">
                    <div class="profile-dropdown-subtitle">Admin</div>
                    <button class="profile-dropdown-item" onclick="document.getElementById('csvFile')?.click(); toggleProfileMenu();">
                        <span class="profile-item-icon">üì•</span>
                        <span>Importar CSV</span>
                    </button>
                    <button class="profile-dropdown-item" onclick="exportarCSV(); toggleProfileMenu();">
                        <span class="profile-item-icon">üì§</span>
                        <span>Exportar CSV</span>
                    </button>
                    <button class="profile-dropdown-item" onclick="accionReconciliarEstados(); toggleProfileMenu();">
                        <span class="profile-item-icon">üß©</span>
                        <span>Reconciliar estados</span>
                    </button>
                    <button class="profile-dropdown-item" onclick="accionDepurarHerramientas(); toggleProfileMenu();">
                        <span class="profile-item-icon">üßπ</span>
                        <span>Depurar herramientas</span>
                    </button>
                    <button class="profile-dropdown-item" onclick="showView('usuarios'); toggleProfileMenu();">
                        <span class="profile-item-icon">üë•</span>
                        <span>Gesti√≥n de usuarios</span>
                    </button>
                </div>
                <button class="profile-dropdown-item" onclick="showView('ayuda'); toggleProfileMenu();">
                    <span class="profile-item-icon">‚ùì</span>
                    <span>Ayuda</span>
                </button>
                <div class="profile-dropdown-divider"></div>
                <button class="profile-dropdown-item" onclick="cambiarCuenta()">
                    <span class="profile-item-icon">üîÑ</span>
                    <span>Cambiar Cuenta</span>
                </button>
                <button class="profile-dropdown-item logout" onclick="cerrarSesion()">
                    <span class="profile-item-icon">üö™</span>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MEN√ö PRINCIPAL -->
    <div id="menuPrincipal" class="view active">
        <div class="menu-container">
            <h3>Men√∫ Principal</h3>
            <div class="menu-grid">
                <button onclick="showView('salon')" class="menu-btn">
                    <div class="menu-icon">üè¢</div>
                    <div class="menu-label">Sal√≥n</div>
                </button>
                <button onclick="showView('usuarios')" class="menu-btn">
                    <div class="menu-icon">üë•</div>
                    <div class="menu-label">Usuarios</div>
                </button>
                <button onclick="showView('nuevaHerramienta')" class="menu-btn">
                    <div class="menu-icon">üîß</div>
                    <div class="menu-label">Nueva Herramienta</div>
                </button>
                <button onclick="showView('reportes')" class="menu-btn">
                    <div class="menu-icon">üìä</div>
                    <div class="menu-label">Reportes</div>
                </button>
                <button onclick="showView('historial')" class="menu-btn">
                    <div class="menu-icon">üìú</div>
                    <div class="menu-label">Historial</div>
                </button>
            </div>
        </div>
    </div>
    
        <!-- Panel de Notificaciones + Fondo borroso -->
        <div id="notificacionesBackdrop" class="notifications-backdrop" style="display:none;"></div>
        <div id="panelNotificaciones" class="notifications-panel" style="display:none;">
            <div class="notifications-header">
                <h3>Notificaciones</h3>
                <button class="btn-close" onclick="cerrarNotificaciones()">‚úï</button>
            </div>
            <div id="listaNotificaciones" class="notifications-list"></div>
        </div>

    <!-- VISTA SAL√ìN -->
    <div id="salon" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Gesti√≥n del Sal√≥n</h3>
            <button onclick="refrescarSalon()" class="btn-refresh">üîÑ Refrescar</button>
        </div>
        
        <div class="salon-container">
            <!-- Panel izquierdo: Registro y b√∫squeda de usuarios -->
            <div class="salon-panel">
                <div class="panel-section">
                    <h4>Registrar Usuario del Sal√≥n</h4>
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="salonNombre" placeholder="Nombre del usuario">
                    </div>
                    <div class="form-group">
                        <label>Equipo:</label>
                        <input type="text" id="salonEquipo" placeholder="N√∫mero de equipo">
                    </div>
                    <button onclick="registrarUsuarioSalon()" class="btn-primary">Registrar</button>
                </div>

                <div class="panel-section">
                    <h4>Buscar Usuarios del Sal√≥n</h4>
                    <input type="text" id="buscarUsuarioSalon" placeholder="Buscar por nombre..." oninput="buscarUsuariosSalon()">
                    <div id="listaUsuariosSalon" class="lista-items"></div>
                </div>

                <div class="panel-section">
                    <h4>Herramientas del Usuario Seleccionado <span id="contadorHerramientasUsuario" class="badge-counter">‚Äî</span></h4>
                    <div id="nombreUsuarioSeleccionado" class="info-text">Ning√∫n usuario seleccionado</div>
                    <div id="herramientasUsuario" class="lista-herramientas"></div>
                </div>
            </div>

            <!-- Panel derecho: Herramientas disponibles -->
            <div class="salon-panel">
                <div class="panel-section">
                    <h4>Todas las Herramientas</h4>
                    <div class="form-group">
                        <label>Buscar herramienta:</label>
                        <input type="text" id="buscarHerramientaSalon" placeholder="Buscar por nombre..." oninput="filtrarHerramientas()">
                    </div>
                    <div class="filter-group">
                        <label><input type="radio" name="filtroHerramientas" value="todas" checked onchange="filtrarHerramientas()"> Todas</label>
                        <label><input type="radio" name="filtroHerramientas" value="libres" onchange="filtrarHerramientas()"> Libres</label>
                        <label><input type="radio" name="filtroHerramientas" value="enUso" onchange="filtrarHerramientas()"> En Uso</label>
                    </div>
                    <div id="listaHerramientas" class="lista-items"></div>
                </div>

                        <div class="panel-section">
                            <h4>Herramientas Da√±adas</h4>
                            <div class="form-group">
                                <label for="buscarHerramientaDanada">Buscar</label>
                                <input type="text" id="buscarHerramientaDanada" placeholder="Escribe para filtrar..." oninput="filtrarHerramientasDanadas()" />
                            </div>
                            <div id="listaHerramientasDanadas" class="lista-items lista-danadas"></div>
                        </div>
            </div>
        </div>
    </div>

    <!-- VISTA USUARIOS -->
    <div id="usuarios" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Gesti√≥n de Usuarios</h3>
        </div>
        
        <div class="usuarios-container">
            <div class="panel-section">
                <h4>Buscar Usuarios</h4>
                <input type="text" id="buscarUsuario" placeholder="Buscar por nombre..." oninput="buscarUsuarios()">
                <div id="listaUsuarios" class="lista-items"></div>
            </div>

            <div class="panel-section">
                <h4 id="usuarioFormTitle">Crear Nuevo Usuario</h4>
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="usuarioNombre" placeholder="Nombre del usuario">
                </div>
                <div class="form-group">
                    <label>Equipo:</label>
                    <input type="text" id="usuarioEquipo" placeholder="N√∫mero de equipo">
                </div>
                <div class="form-actions">
                    <button onclick="guardarUsuario()" class="btn-primary">Guardar</button>
                    <button onclick="cancelarEdicionUsuario()" class="btn-secondary" id="btnCancelarUsuario" style="display:none">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA NUEVA HERRAMIENTA -->
    <div id="nuevaHerramienta" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Nueva Herramienta</h3>
        </div>
        
        <div class="herramienta-container">
            <div class="panel-section">
                <h4>Crear Herramienta Manualmente</h4>
                <div class="form-group">
                    <label>Nombre de la Herramienta:</label>
                    <input type="text" id="herramientaNombre" placeholder="Ej: Micr√≥fono inal√°mbrico">
                </div>
                <button onclick="crearHerramienta()" class="btn-primary">Crear Herramienta</button>
            </div>

            <div class="panel-section">
                <h4>Importar desde CSV</h4>
                <p class="info-text">Formatos aceptados:</p>
                <ul class="info-list">
                    <li>Con cabecera: id, nombre, enUso</li>
                    <li>Sin cabecera: nombre[,enUso]</li>
                    <li>Valores aceptados para enUso: true, 1, si, s√≠, en uso, usada, ocupada</li>
                </ul>
                <input type="file" id="csvFile" accept=".csv" onchange="previewCSV()">
                <div id="csvPreview" class="csv-preview"></div>
                <button onclick="importarCSV()" class="btn-primary" id="btnImportarCSV" disabled>Importar CSV</button>
            </div>

            <div class="panel-section">
                <h4>Listado de Herramientas</h4>
                <div class="form-group">
                    <label for="buscarHerramientaNueva">Buscar Herramienta:</label>
                    <input type="text" id="buscarHerramientaNueva" placeholder="Buscar por nombre..." oninput="buscarHerramientasNueva()">
                </div>
                <div id="listaHerramientasNueva" class="lista-items"></div>
            </div>
        </div>
    </div>

    <!-- VISTA REPORTES -->
    <div id="reportes" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Reportes</h3>
        </div>
        
        <div class="reportes-container">
            <div class="panel-section">
                <h4>Exportar Movimientos</h4>
                <p class="info-text">Exporta todos los movimientos registrados en el sistema a un archivo CSV.</p>
                <p class="info-text">Campos incluidos: tipo, usuarioSalonId, herramientaId, usuarioSistema, fecha</p>
                <button onclick="exportarMovimientos()" class="btn-primary">üì• Exportar a CSV</button>
            </div>

            <div class="panel-section">
                <h4>Estad√≠sticas</h4>
                <div id="estadisticas" class="estadisticas-grid"></div>
            </div>
        </div>
    </div>

    <!-- VISTA HISTORIAL -->
    <div id="historial" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Historial</h3>
        </div>
        
        <div class="historial-container">
            <div class="panel-section">
                <h4>Filtros de B√∫squeda</h4>
                <div class="form-group">
                    <label>Buscar Usuario:</label>
                    <input type="text" id="buscarHistorialUsuario" placeholder="Buscar por nombre..." oninput="buscarHistorialUsuarios()">
                    <div id="listaHistorialUsuarios" class="lista-items"></div>
                </div>

                <div class="form-group">
                    <label>Buscar Herramienta:</label>
                    <input type="text" id="buscarHistorialHerramienta" placeholder="Buscar por nombre..." oninput="buscarHistorialHerramientas()">
                    <div id="listaHistorialHerramientas" class="lista-items"></div>
                </div>

                <button onclick="buscarHistorial()" class="btn-primary">Buscar</button>
                <button onclick="limpiarFiltrosHistorial()" class="btn-secondary">Limpiar Filtros</button>
            </div>

            <div class="panel-section">
                <h4>Resultados</h4>
                <div id="resultadosHistorial" class="historial-resultados"></div>
            </div>
        </div>
    </div>

    <!-- VISTA AYUDA -->
    <div id="ayuda" class="view">
        <div class="view-header">
            <button onclick="showView('menuPrincipal')" class="btn-back">‚Üê Volver</button>
            <h3>Ayuda</h3>
        </div>
        
        <div class="ayuda-container">
            <div class="panel-section">
                <h4>üìñ Gu√≠a de Uso</h4>
                
                <div class="ayuda-item">
                    <h5>üè¢ Sal√≥n (Gesti√≥n Principal)</h5>
                    <ul>
                        <li><strong>Registrar usuario:</strong> Ingresa nombre y equipo. El ID se crea autom√°ticamente en min√∫sculas.</li>
                        <li><strong>Buscar usuarios:</strong> Escribe en el campo de b√∫squeda y haz doble clic para seleccionar.</li>
                        <li><strong>Ver herramientas del usuario:</strong> Selecciona un usuario para ver sus herramientas asignadas.</li>
                        <li><strong>Asignar herramienta:</strong> Haz doble clic en una herramienta libre.</li>
                        <li><strong>Devolver herramienta:</strong> Selecciona una herramienta del usuario y usa el bot√≥n "Entregar" que aparece.</li>
                        <li><strong>Marcar como da√±ada:</strong> Arrastra una herramienta desde el usuario a la lista de da√±adas.</li>
                        <li><strong>Eliminar usuario:</strong> Solo se puede eliminar si no tiene herramientas asignadas.</li>
                    </ul>
                </div>

                <div class="ayuda-item">
                    <h5>üîß Nueva Herramienta</h5>
                    <ul>
                        <li><strong>Manual:</strong> Ingresa el nombre de la herramienta. El ID se crea en min√∫sculas.</li>
                        <li><strong>Importar CSV:</strong> Acepta archivos con o sin cabecera.</li>
                        <li><strong>Formatos CSV:</strong> Con cabecera (id, nombre, enUso) o sin cabecera (nombre[,enUso]).</li>
                        <li><strong>Valores enUso:</strong> true, 1, si, s√≠, en uso, usada, ocupada.</li>
                    </ul>
                </div>

                <div class="ayuda-item">
                    <h5>üë• Usuarios</h5>
                    <ul>
                        <li><strong>Buscar:</strong> Filtra usuarios por nombre.</li>
                        <li><strong>Crear/Editar:</strong> Haz doble clic en un usuario para editarlo.</li>
                        <li><strong>Guardar:</strong> El ID se genera autom√°ticamente en min√∫sculas.</li>
                    </ul>
                </div>

                <div class="ayuda-item">
                    <h5>üìä Reportes</h5>
                    <ul>
                        <li><strong>Exportar:</strong> Descarga todos los movimientos en formato CSV.</li>
                        <li><strong>Campos:</strong> tipo, usuarioSalonId, herramientaId, usuarioSistema, fecha.</li>
                    </ul>
                </div>

                <div class="ayuda-item">
                    <h5>üìú Historial</h5>
                    <ul>
                        <li><strong>Buscar usuario:</strong> Escribe y haz doble clic para seleccionar.</li>
                        <li><strong>Buscar herramienta:</strong> Escribe y haz doble clic para seleccionar.</li>
                        <li><strong>Aplicar filtros:</strong> Presiona "Buscar" para ver los resultados.</li>
                    </ul>
                </div>

                <div class="ayuda-item">
                    <h5>‚ö†Ô∏è Notas Importantes</h5>
                    <ul>
                        <li>Todos los IDs se generan en min√∫sculas autom√°ticamente.</li>
                        <li>Una herramienta "En uso" no se puede asignar a otro usuario.</li>
                        <li>No se puede eliminar un usuario que tenga herramientas asignadas.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n personalizado -->
    <div id="confirmModal" class="confirm-modal" style="display:none">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">Confirmar acci√≥n</div>
            <div class="confirm-modal-body" id="confirmMessage"></div>
            <div class="confirm-modal-actions">
                <button id="confirmCancel" class="btn-secondary">Cancelar</button>
                <button id="confirmOk" class="btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <footer>
        ¬© 2025 Gesti√≥n de equipos
    </footer>

<!-- Overlay de carga -->
<div id="loadingOverlay" class="loading-overlay" style="display:none" aria-hidden="true">
    <div class="loading-backdrop"></div>
    <div class="loading-spinner" role="status" aria-live="polite" aria-label="Cargando">
        <div class="spinner-ring"></div>
        <div class="spinner-text">Cargando‚Ä¶</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<script src="config.js?v=20251201"></script>
<script src="inicio.js?v=20251201"></script>
</body>
</html>